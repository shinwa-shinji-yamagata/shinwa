各プログラムの概要

フォルダ毎に機能分け
GoogleDrive（フォルダやスプレッドシート）を操作するプログラムについては、晋二の個人ユーザー
「shinwa.shinji.yamagata@gmail.com」内に設置したものにしか使えない。

別のユーザーのGoogleDrive内にあるファイル類に対して何らかのプログラムを実行させたい場合、
そのユーザーでGoogleConsoleでOauth2.0の作成、JSON（鍵）ダウンロードなどをし、プログラムが
その情報を読み込んで処理する必要がある。


◆フォルダ「api」
日毎現場表のオートコンプリート機能を実現するためのAPI
スプレッドシートのGAS（GoogleAppScript）に直接書き込むコード（App Script.js）とサーバーに
設置してDB検索するコード（autocomplete.php）で構成される。
autocomplete.phpではOpenAI（GPT-4o）を使って検索文字列から想定される病院名の候補を出し、
その候補からDB検索することでPROCESSに登録されている病院名の一覧を返す。

◆フォルダ「chatbot」
新和なんでもAIチャットボット君
chat.phpは問い合わせに対して処理するAI本体。
learning.phpはAIモデルに学習させるプログラム。
docフォルダに学習させたいファイル（Word,Excel,PDF,PowerPoint）を設置して以下のURLにアクセスすると学習する。
https://shinwa1.com/chatbot/learning.php


◆フォルダ「gdrive_add_role」
指定したGoogleクラウド上にあるファイル類のIDに対し、CSVファイルの中に設定した
ユーザーの権限を一括で付与するプログラム。

現時点で「日毎管理表」と「Googleアカウント管理」と2つの対象に対して、社員の数だけ権限を追加する
作業が必要となっており、今後権限を追加するファイルやフォルダが増える度に社員の数だけ権限を追加する
作業が発生する想定で、その手間を省くために作成。

サーバー上でコマンドラインからPHPを実行する。
#cd C:\xampp\htdocs\gdrive_add_role
#php add_role.php <fileId> [csvPath]

fileIdにはGoogleDriveにあるフォルダやスプレッドシートのIDを指定する。
csvPathには読み込むCSVファイルを指定する。
CSVファイルを指定しない場合はデフォルトの「permissions.csv」が読み込まれる。

CSVファイルには「Gmailアドレス」,「権限」の2カラムを設定する。（最初の1行目はヘッダーとして無視される）
権限に指定できる項目は以下の3通り。
・閲覧者
・編集者
・コメンター

「閲覧者」「編集者」以外の文字が入っている場合はすべて「コメンター」として扱われる。


◆フォルダ「get_today_sheet_url」
現在の日付を取得し「日毎管理表」の現在日のシートへの直リンク（URL）を取得するプログラム。
ダイレクトに当日の日毎管理表が開けるようになり、利便性が向上する。

サーバーのcronにより、毎日午前「00:00:10」に自動実行される。

取得した当日のURLはDBに保存され、サーバーのウェブページがDBを参照して直リンク
「日毎管理表（今日）」
を表示する仕組みとしている。


◆フォルダ「google-ss-copy」
・ss-copy.php
「日毎管理表」のテンプレートファイルを翌月の「日毎管理表」としてコピーするプログラム。

サーバーのcronにより、毎月1日の「06:00:00」に自動実行される。

例：
・2025年10月1日に実行された場合、テンプレートファイルから2025年フォルダの下に「2025年11月」の
　日毎管理表を作成する。

・2025年12月1日に実行された場合、2026年フォルダを作成し、2026年フォルダの下に「2026年1月」の
　日毎管理表を作成する。

テンプレートファイルは31日までのシートが固定で入っているが、月によって存在しない日については
コピーした後に自動で削除する。
11月の場合は31日シートが削除され、2月の場合は29日～31日までのシートが削除される。
2月についてはうるう年も判断して削除を行う。

・ss-backup.php
「日毎管理表」の日時バックアップをするプログラム。

サーバーのcronにより、毎日「7:00」に自動実行される。
これにより、シートが削除されたりシートが壊れた時に、最悪当日7時の時点に戻すことができる。
バックアップは3か月分保持し、それ以前のバックアップファイルは削除する。

◆フォルダ「lightning」
当サーバーではWordPressというウェブサイト構築ツールを利用してウェブサイトを作っている。
「lightning」というのはWordPressの「テーマ」名であり、サーバー内の以下の場所に存在している。
・/home/shinwa1.com/public_html/wp-content/themes/lightning

この中にあるphpファイルについて内容を説明

・functions.php
WordPress自体の動作に関わる基本的な命令が書かれたファイル。
これに様々な機能を追加している。
－ログインしていないユーザーがアクセスした場合に、ログインページにリダイレクトする機能を追加
－jQuery（Ajaxと呼ばれるブラウザでカレンダーや非同期通信といった高度なものを実現する技術）を
　読み込む機能を追加
－WordPressでページを作る際、ショートコードで独自PHPを読み込み実行させ、静的ページから動的ページに
　するための機能を追加
－新和向けに以下のユーザー権限を追加
　経理、総務、設計部、工事部、工事事務、購買、技術営業、その他
　（WordPressに標準で備わっている閲覧者、投稿者、編集者、といった不要な権限は削除）

◆フォルダ「lightning」内のフォルダ「shinwa」
・chatbot.php
新和なんでもAIチャットボット君の画面表示用PHPファイル。
WordpressのショートコードでこのPHPを読み込ませて表示させている。

・display_gyousya_master.php
業者マスタ画面表示用PHPファイル。
WordpressのショートコードでこのPHPを読み込ませて表示させている。

・get_today_sheet_url.php
TOPページの「日毎管理表（今日）」の部分をショートコードの独自PHP読み込み機能を行って呼び出される
PHPファイル。
このPHPはDBを読み込み、「日毎管理表」の当日シートへの直リンクURLを以下のようなHTML形式で表示する。

<a href='$url' target='_blank'>日毎管理表（今日）</a>
（$urlにはDBから取得したURLが入る。）

・insert_genba_master.php
現場マスタの画面表示用PHPファイル。
WordpressのショートコードでこのPHPを読み込ませて表示させている。

・genba_list_partial.php
現場マスタのページング用PHPファイル。

・log_display.php
ログ表示の画面表示用PHPファイル。
WordpressのショートコードでこのPHPを読み込ませて表示させている。

・log_display_partial.php
ログ表示のページング用

・login_chk.php
ログインしていない時にログインページにリダイレクトさせるPHP

・monthly_sum_day_kanri_sheet.php
「日毎管理表 月次集計」ページのショートコードに指定し、当該ページが表示されると処理されるPHPファイル。

PHPでは年月を指定するテキストボックスと、集計実行するボタンを出力する。
現在の年月を取得し、1か月前の年月をデフォルト値としてテキストボックスに表示し、
jQueryを使って年月のみのカレンダーを実装し、マウス操作で年月選択を可能にしている。
総務と経理のみ実行可能にする制御も行う。
実行中に別の人に同時実行されないよう、DBにフラグを持たせて排他制御も行う。

集計実行されると、フォルダ「google-ss-summary」内の「post_day_kanri_summary.php」をjQueryの非同期通信で
呼び出して集計を行い、集計結果（正常orエラー）を判定して結果を表示する。
正常の場合は該当する年月の「月集計」シートへの直リンクを取得してブラウザに表示する。

・seikyu_front.php
請求書→PROCESS向けExcelの画面表示用PHPファイル。
WordpressのショートコードでこのPHPを読み込ませて表示させている。

・staff_master.php
社員マスタの画面表示用PHPファイル。
WordpressのショートコードでこのPHPを読み込ませて表示させている。

◆テキスト「google-ss-monthly_sum_js.txt」
現在使われていないが、これを日毎管理表スプレッドシートのAppScriptに貼り付けて実行すると、
そのスプレッドシート内の1日～31日までのシートを集計して「月集計」シートに書き込む。

実行するにはスプレッドシート作成者の承認を得る必要があり、スプレッドシート毎に承認が必要で
さらに処理も遅く運用に適さないことからサーバーで集計することにした。

スプレッドシートでマクロを組む時の参考として、テキストで残している。


◆フォルダ「post」
各画面からPOST送信され、それを受信するPHPファイル群を設置。

・higoto_genba_summary.php
日毎表の月集計を行うPHP（親）

・higoto_summary.php
日毎表の月集計を行うPHP（子）
higoto_genba_summary.phpから呼び出される。

・insert_genba_master.php
アップロードされたExcelの内容で現場マスタを更新するPHP

・insert_gyousya_master.php
アップロードされたExcelの内容で業者マスタを更新するPHP

・seikyu_upload.php
アップロードされた複数の請求書をuploadsフォルダに保存するPHP

・seikyu_process.php
アップロードされた請求書毎に画面表示をし、業者名、現場名等を入力させるためのPHP

・seikyu_write.php
入力された請求書の内容でPROCESS向けExcelを生成するPHP

・seikyu_reset.php
ExcelダウンロードしたらアップロードされたExcelファイル達を削除、セッションも削除するPHP

・shiwake.php
日毎現場表の月集計シートからPROCESS向けExcel（仕分）ファイルを生成するPHP

・template.xlsx
PROCESS向けExcelのテンプレートファイル


